name: Commit Review to Slack

on:
  push:
    branches-ignore:
      - main
      - master
      - dev
    paths:
      - 'src/**/*.ts'
      - 'src/**/*.tsx'

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # HEAD~1 비교를 위해 2개 커밋 필요

      - name: Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            커밋 변경사항을 리뷰하고 `review-result.json` 파일로 저장해주세요.

            ## 1단계: 변경사항 확인
            다음 명령어로 이전 커밋과의 diff 확인:
            ```bash
            git diff HEAD~1 HEAD -- "src/**/*.ts" "src/**/*.tsx"
            ```

            ## 2단계: 코드 리뷰
            다음 기준으로 분석:
            - **Correctness**: 버그, 논리 오류
            - **Security**: XSS, SQL Injection, 민감정보 노출
            - **TypeScript**: any 사용, 타입 정의 엄격성
            - **Error Handling**: try-catch, edge case 처리
            - **Maintainability**: 가독성, 네이밍, 모듈화
            - **Convention**: GEMINI.md 가이드 준수
            - **Performance**: 불필요한 리렌더링, 비효율적 연산

            ## 3단계: JSON 파일 저장
            `review-result.json` 파일을 다음 형식으로 작성:

            ```json
            {
              "summary": "변경사항 1-2문장 요약",
              "category": "excellent|good|needs-attention|critical",
              "highlights": ["잘한 점 1", "잘한 점 2"],
              "suggestions": ["개선 제안 1", "개선 제안 2"],
              "score": 8,
              "files_changed": ["src/app/page.tsx", "src/lib/utils.ts"]
            }
            ```

            **톤**: 건설적이고 친근하게. 한국어로 작성.
            **카테고리 기준**:
            - excellent: 완벽하거나 모범 사례
            - good: 대체로 양호, 사소한 개선사항만
            - needs-attention: 중요한 개선 필요
            - critical: 버그/보안 이슈 있음

          claude_args: '--allowed-tools "Read,Glob,Bash(git *),Write(review-result.json)"'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @slack/webhook tsx --no-save

      - name: Send to Slack
        run: npx tsx scripts/slack-sender.ts
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_LIVE_WEBHOOK_URL }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          GITHUB_REF: ${{ github.ref }}
