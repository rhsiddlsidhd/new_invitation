name: Claude Code Auto-Fixer

on:
  pull_request_review_comment:
    types: [created]

jobs:
  auto-fix:
    # '/fix' í‚¤ì›Œë“œê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (ì‘ì„±ìê°€ ë´‡ì¸ ê²½ìš° ì œì™¸)
    if: contains(github.event.comment.body, '/fix') && github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }} # PR ëŒ€ìƒ ë¸Œëœì¹˜ ì²´í¬ì•„ì›ƒ
          fetch-depth: 0

      - name: Run Claude Fixer
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            ë‹¹ì‹ ì€ PR ë¦¬ë·° í”¼ë“œë°±ì„ ì½”ë”©ì— ì§ì ‘ ë°˜ì˜í•˜ëŠ” ì‹œë‹ˆì–´ ê°œë°œìì…ë‹ˆë‹¤.
            ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ê³  ë¸Œëœì¹˜ì— ë°˜ì˜í•˜ì„¸ìš”.

            [ì‚¬ìš©ì ìš”ì²­ ë° ë§¥ë½]
            1. ìš”ì²­ ì½”ë©˜íŠ¸: "${{ github.event.comment.body }}"
            2. ìˆ˜ì • ëŒ€ìƒ íŒŒì¼: `${{ github.event.comment.path }}`
            3. PR ë²ˆí˜¸: ${{ github.event.pull_request.number }}

            [ì‘ì—… ì§€ì¹¨]
            1. **ìƒíƒœ ë¶„ì„**: 
               - `gh pr view`ë¥¼ í†µí•´ PRì˜ ì „ì²´ ë¦¬ë·° ì½”ë©˜íŠ¸ ëª©ë¡ì„ í™•ì¸í•˜ì„¸ìš”.
               - ì‚¬ìš©ìê°€ "/fix 2ë²ˆ"ì²˜ëŸ¼ ë²ˆí˜¸ë¥¼ ì§€ì •í–ˆë‹¤ë©´, ë¦¬ë·° ëª©ë¡ ì¤‘ í•´ë‹¹ ë²ˆí˜¸ì˜ ë‚´ìš©ë§Œ ìˆ˜ì •í•˜ì„¸ìš”.
               - ë²ˆí˜¸ê°€ ì—†ë‹¤ë©´(ì˜ˆ: "/fix"), í˜„ì¬ íŒŒì¼ì— ë‚¨ê²¨ì§„ ëª¨ë“  ë¯¸í•´ê²° ë¦¬ë·° ì‚¬í•­ì„ ìˆ˜ì •í•˜ì„¸ìš”.

            2. **ì½”ë“œ ìˆ˜ì •**:
               - `${{ github.event.comment.path }}` íŒŒì¼ ë‚´ìš©ì„ ì½ê³ (`cat`), ìš”ì²­ë°›ì€ í”¼ë“œë°±ì— ë§ì¶° ë¡œì§ì„ ê°œì„ í•˜ì„¸ìš”.
               - ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ ì½”ë”© ìŠ¤íƒ€ì¼ê³¼ `CLAUDE.md`(ìˆëŠ” ê²½ìš°)ì˜ ì§€ì¹¨ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì„¸ìš”.

            3. **ë³€ê²½ ì‚¬í•­ ë°˜ì˜**:
               - ìˆ˜ì •ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ì„¸ìš”.
                 * `git config --local user.email "github-actions[bot]@users.noreply.github.com"`
                 * `git config --local user.name "github-actions[bot]"`
                 * `git add .`
                 * `git commit -m "[AI] Fix: ë¦¬ë·° ë°˜ì˜ (${{ github.event.comment.id }})"`
                 * `git push origin ${{ github.event.pull_request.head.ref }}`

            4. **í”¼ë“œë°± ì™„ë£Œ ë³´ê³ **:
               - ìˆ˜ì •ì„ ì„±ê³µì ìœ¼ë¡œ ë§ˆì³¤ë‹¤ë©´, `gh pr comment`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ë‚´ìš©ì„ ëŒ“ê¸€ë¡œ ë‚¨ê¸°ì„¸ìš”.
                 * "âœ… ë°˜ì˜ëœ í•­ëª©: (ì˜ˆ: 2ë²ˆ ì ‘ê·¼ì„± ê°œì„ )"
                 * "ğŸ“ ìˆ˜ì • íŒŒì¼: `${{ github.event.comment.path }}`"
                 * "ğŸ’¡ í™•ì¸ í›„ ë¡œì»¬ì—ì„œ `git pull`ì„ ì§„í–‰í•´ ì£¼ì„¸ìš”."

            ëª¨ë“  ë‹¨ê³„ëŠ” Bash ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ ìˆ˜í–‰í•˜ì„¸ìš”.

          # í•„ìˆ˜ ê¶Œí•œ ë„êµ¬ ì„¤ì •
          claude_args: '--allowed-tools "Bash(git:*),Bash(gh pr comment:*),Bash(gh pr view:*),Bash(cat:*),Bash(ls:*),Bash(sed:*)"'
