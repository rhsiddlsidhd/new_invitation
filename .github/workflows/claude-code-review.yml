name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - "src/**/*.ts"
      - "src/**/*.tsx"
      - "src/**/*.js"

jobs:
  claude-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

          prompt: |
            시니어 개발자로서 PR #${{ github.event.pull_request.number }}를 리뷰하고 한국어로 피드백을 남겨주세요.

            ## Preparation
            1. `GEMINI.md` 파일을 읽고 프로젝트 컨벤션과 아키텍처 규칙 파악
            2. `gh pr diff ${{ github.event.pull_request.number }}` - 변경사항 확인 (src/ 디렉토리 집중)
            3. `gh pr view ${{ github.event.pull_request.number }} --comments` - 기존 코멘트 확인
            4. 이미 지적된 내용은 다시 언급하지 않음

            ## In-Depth Analysis
            다음 기준으로 코드 변경사항 분석:

            - **Correctness**: 코드가 의도한 대로 동작하는가? 버그나 논리 오류는 없는가?
            - **Maintainability**: 가독성, 네이밍, 모듈화가 명확하며 미래에 수정하기 쉬운가?
            - **TypeScript**: `any` 지양, 타입 정의가 엄격한가?
            - **Error Handling**: try-catch, edge case(null/undefined/빈배열) 처리가 적절한가?
            - **Security**: XSS, SQL Injection, 민감정보 노출 등 보안 취약점은 없는가?
            - **Convention**: GEMINI.md 가이드(상태관리, API 규약, 에러 핸들링 등)를 준수하는가?
            - **Architecture**: 컴포넌트 크기, 비즈니스 로직과 UI 분리가 적절한가?
            - **Performance**: 불필요한 리렌더링이나 비효율적 연산은 없는가?
            - **Testability**: 테스트 커버리지가 충분한가? 추가 테스트 케이스를 제안할 수 있는가?

            ## Provide Feedback
            `gh pr comment ${{ github.event.pull_request.number }} --body "..."` 형식으로 다음 구조로 작성:

            ### Summary
            전반적인 코드 품질에 대한 간략한 총평 (2-3문장)

            ### Findings
            - **Critical**: 버그, 보안 이슈, Breaking Changes (없으면 "✅ 없음")
            - **Improvements**: 코드 품질, 성능 개선 제안 (없으면 "✅ 없음")
            - **Nitpicks**: 포맷팅, 스타일 이슈 (선택적, 없으면 "✅ 없음")

            각 지적사항은 다음 형식으로:
            - [파일명:라인번호] 이슈 제목
            - 문제점 설명
            - 현재 코드 예시
            - 권장 코드 예시
            - 개선 이유 (기술적 근거 필수)

            ### Conclusion
            - **APPROVED**: 머지 가능 또는
            - **REQUEST CHANGES**: 수정 필요

            ## Tone
            - 건설적이고 전문적이며 친근하게
            - 모든 변경 요청에 대해 "왜" 필요한지 설명
            - 추상적인 지적 금지, 구체적인 코드로 보여주기

          claude_args: '--allowed-tools "Read,Glob,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"'
